<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - Products | FreshMart</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="style.css">
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen">
  
  <!-- Header -->
  <header class="bg-white shadow-sm border-b sticky top-0 z-10">
    <div class="max-w-7xl mx-auto px-4 py-4">
      <div class="flex justify-between items-center">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-full bg-green-600 flex items-center justify-center text-white font-bold">
            F
          </div>
          <div>
            <h1 class="text-2xl font-bold text-gray-900">FreshMart Admin</h1>
            <p class="text-xs text-gray-500">Product Management</p>
          </div>
        </div>
        <div class="flex gap-3 items-center">
          <span class="hidden sm:inline text-sm text-gray-600">
            üë§ <span id="adminUsername">Admin</span>
          </span>
          <a href="admin_orders.html" 
             class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-medium transition">
            üì¶ Orders
          </a>
          <button onclick="logout()" 
                  class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 text-sm font-medium transition">
            Logout
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="max-w-7xl mx-auto px-4 py-6">
    
    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <div class="bg-white rounded-xl shadow-sm p-4 border-l-4 border-green-500">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-600">Total Products</p>
            <p class="text-2xl font-bold text-gray-900" id="totalProducts">0</p>
          </div>
          <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
            <span class="text-2xl">üì¶</span>
          </div>
        </div>
      </div>
      
      <div class="bg-white rounded-xl shadow-sm p-4 border-l-4 border-blue-500">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-600">Categories</p>
            <p class="text-2xl font-bold text-gray-900" id="totalCategories">0</p>
          </div>
          <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
            <span class="text-2xl">üè∑Ô∏è</span>
          </div>
        </div>
      </div>
      
      <div class="bg-white rounded-xl shadow-sm p-4 border-l-4 border-purple-500">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-600">Last Updated</p>
            <p class="text-sm font-semibold text-gray-900" id="lastUpdated">Just now</p>
          </div>
          <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center">
            <span class="text-2xl">üïí</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Add Product Form -->
    <div class="bg-white shadow-lg rounded-xl p-6 mb-6 border">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-bold text-gray-900">‚ûï Add New Product</h2>
        <button onclick="toggleAddForm()" id="toggleFormBtn" 
                class="text-sm text-gray-600 hover:text-gray-900">
          Hide Form
        </button>
      </div>
      
      <form id="addProductForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Product Name *</label>
          <input type="text" id="newName" placeholder="e.g., Fresh Tomatoes" 
                 class="w-full border border-gray-300 rounded-lg px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-green-500" 
                 required />
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Price (‚Çπ) *</label>
          <input type="number" step="0.01" id="newPrice" placeholder="0.00" 
                 class="w-full border border-gray-300 rounded-lg px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-green-500" 
                 required />
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Category</label>
          <select id="newCategory" 
                  class="w-full border border-gray-300 rounded-lg px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-green-500">
            <option value="">Select category</option>
            <option value="Vegetables">ü•¶ Vegetables</option>
            <option value="Fruits">üçé Fruits</option>
            <option value="Dairy">ü•õ Dairy</option>
            <option value="Bakery">üçû Bakery</option>
            <option value="Other">üì¶ Other</option>
          </select>
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Image URL</label>
          <input type="url" id="newImageUrl" placeholder="https://example.com/image.jpg" 
                 class="w-full border border-gray-300 rounded-lg px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-green-500" />
        </div>
        
        <div class="md:col-span-2">
          <button type="submit" 
                  class="w-full md:w-auto bg-green-600 text-white px-8 py-3 rounded-lg hover:bg-green-700 font-semibold shadow-md transition">
            ‚ûï Add Product
          </button>
        </div>
      </form>
    </div>

    <!-- Products Table -->
    <div class="bg-white shadow-lg rounded-xl border overflow-hidden">
      <div class="p-6 border-b bg-gray-50">
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
          <h2 class="text-xl font-bold text-gray-900">üìã All Products</h2>
          <div class="flex gap-2">
            <input type="text" id="searchProducts" placeholder="üîç Search products..." 
                   class="border border-gray-300 rounded-lg px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-green-500">
            <button onclick="loadProducts()" 
                    class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm font-medium transition">
              üîÑ Refresh
            </button>
          </div>
        </div>
      </div>
      
      <div class="overflow-x-auto">
        <table class="min-w-full">
          <thead class="bg-gray-100 border-b">
            <tr>
              <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">ID</th>
              <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Image</th>
              <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Name</th>
              <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Price</th>
              <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Category</th>
              <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Actions</th>
            </tr>
          </thead>
          <tbody id="productsTableBody" class="divide-y divide-gray-200">
            <tr>
              <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                <div class="flex flex-col items-center gap-2">
                  <div class="animate-spin w-8 h-8 border-4 border-green-600 border-t-transparent rounded-full"></div>
                  <p>Loading products...</p>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <!-- Toast Notification -->
  <div id="toast" class="toast hidden">
    <span id="toastMessage"></span>
  </div>

  <script>
    // Supabase Configuration
    const SUPABASE_URL = "https://ujwwiuhmylcrgpofgxly.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVqd3dpdWhteWxjcmdwb2ZneGx5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUzNzMwNjksImV4cCI6MjA4MDk0OTA2OX0.UFPKwGN585SrFZ3Tk8YmC2AYvKMWMRhfthAa_-5QeNY";

    let allProducts = [];

    // Check authentication
    if (sessionStorage.getItem('admin_logged_in') !== 'true') {
      window.location.href = 'admin_login.html';
    }

    // Display username
    const username = sessionStorage.getItem('admin_username') || 'Admin';
    document.getElementById('adminUsername').textContent = username;

    // Toast notification
    function showToast(message, isError = false) {
      const toast = document.getElementById("toast");
      const msg = document.getElementById("toastMessage");
      toast.classList.remove("error");
      if (isError) toast.classList.add("error");
      msg.textContent = message;
      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), 3000);
    }

    // Logout function
    function logout() {
      if (confirm('Are you sure you want to logout?')) {
        sessionStorage.clear();
        window.location.href = 'admin_login.html';
      }
    }

    // Toggle add form visibility
    function toggleAddForm() {
      const form = document.getElementById('addProductForm');
      const btn = document.getElementById('toggleFormBtn');
      if (form.style.display === 'none') {
        form.style.display = 'grid';
        btn.textContent = 'Hide Form';
      } else {
        form.style.display = 'none';
        btn.textContent = 'Show Form';
      }
    }

    // Update stats
    function updateStats() {
      const total = allProducts.length;
      const categories = new Set(allProducts.map(p => p.category).filter(Boolean)).size;
      
      document.getElementById('totalProducts').textContent = total;
      document.getElementById('totalCategories').textContent = categories;
      document.getElementById('lastUpdated').textContent = new Date().toLocaleTimeString();
    }

    // Fetch and display products
    async function loadProducts() {
      try {
        const response = await fetch(`${SUPABASE_URL}/rest/v1/products?select=*&order=id.desc`, {
          headers: {
            'apikey': SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
          }
        });

        allProducts = await response.json();
        renderProducts(allProducts);
        updateStats();
      } catch (error) {
        console.error('Error loading products:', error);
        showToast('Failed to load products', true);
      }
    }

    // Render products table
    function renderProducts(products) {
      const tbody = document.getElementById('productsTableBody');
      
      if (products.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="6" class="px-4 py-8 text-center text-gray-500">
              <p class="text-lg mb-2">üì¶ No products found</p>
              <p class="text-sm">Add your first product using the form above</p>
            </td>
          </tr>`;
        return;
      }

      tbody.innerHTML = products.map(p => `
        <tr class="hover:bg-gray-50 transition" id="row-${p.id}">
          <td class="px-4 py-3 text-sm font-semibold text-gray-900">#${p.id}</td>
          <td class="px-4 py-3">
            ${p.image_url ? 
              `<img src="${p.image_url}" alt="${escapeHtml(p.name)}" 
                    class="w-16 h-16 object-cover rounded-lg shadow-sm" 
                    onerror="this.src='https://via.placeholder.com/100?text=No+Image'">` 
              : '<div class="w-16 h-16 bg-gray-200 rounded-lg flex items-center justify-center text-2xl">üì¶</div>'}
          </td>
          <td class="px-4 py-3">
            <input type="text" value="${escapeHtml(p.name)}" 
                   class="w-full border border-gray-300 rounded px-3 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-green-500" 
                   id="name-${p.id}">
          </td>
          <td class="px-4 py-3">
            <div class="flex items-center gap-1">
              <span class="text-gray-600">‚Çπ</span>
              <input type="number" step="0.01" value="${p.price}" 
                     class="w-24 border border-gray-300 rounded px-3 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-green-500" 
                     id="price-${p.id}">
            </div>
          </td>
          <td class="px-4 py-3">
            <select class="border border-gray-300 rounded px-3 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-green-500" 
                    id="category-${p.id}">
              <option value="">None</option>
              <option value="Vegetables" ${p.category === 'Vegetables' ? 'selected' : ''}>ü•¶ Vegetables</option>
              <option value="Fruits" ${p.category === 'Fruits' ? 'selected' : ''}>üçé Fruits</option>
              <option value="Dairy" ${p.category === 'Dairy' ? 'selected' : ''}>ü•õ Dairy</option>
              <option value="Bakery" ${p.category === 'Bakery' ? 'selected' : ''}>üçû Bakery</option>
              <option value="Other" ${p.category === 'Other' ? 'selected' : ''}>üì¶ Other</option>
            </select>
            <input type="hidden" value="${escapeHtml(p.image_url || '')}" id="imageUrl-${p.id}">
          </td>
          <td class="px-4 py-3">
            <div class="flex gap-2">
              <button onclick="updateProduct(${p.id})" 
                      class="px-3 py-1.5 bg-blue-600 text-white rounded-lg text-xs font-medium hover:bg-blue-700 transition shadow-sm">
                üíæ Save
              </button>
              <button onclick="deleteProduct(${p.id})" 
                      class="px-3 py-1.5 bg-red-600 text-white rounded-lg text-xs font-medium hover:bg-red-700 transition shadow-sm">
                üóëÔ∏è Delete
              </button>
            </div>
          </td>
        </tr>
      `).join('');
    }

    // Search functionality
    document.getElementById('searchProducts').addEventListener('input', (e) => {
      const searchTerm = e.target.value.toLowerCase();
      const filtered = allProducts.filter(p => 
        p.name.toLowerCase().includes(searchTerm) ||
        (p.category || '').toLowerCase().includes(searchTerm)
      );
      renderProducts(filtered);
    });

    // Add product
    document.getElementById('addProductForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const name = document.getElementById('newName').value.trim();
      const price = parseFloat(document.getElementById('newPrice').value);
      const category = document.getElementById('newCategory').value || null;
      const imageUrl = document.getElementById('newImageUrl').value.trim() || null;

      if (!name || !price) {
        showToast('Please fill required fields', true);
        return;
      }

      try {
        const response = await fetch(`${SUPABASE_URL}/rest/v1/products`, {
          method: 'POST',
          headers: {
            'apikey': SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
            'Content-Type': 'application/json',
            'Prefer': 'return=minimal'
          },
          body: JSON.stringify({ name, price, category, image_url: imageUrl })
        });

        if (response.ok) {
          showToast('‚úÖ Product added successfully');
          document.getElementById('addProductForm').reset();
          loadProducts();
        } else {
          showToast('Failed to add product', true);
        }
      } catch (error) {
        console.error('Error adding product:', error);
        showToast('Failed to add product', true);
      }
    });

    // Update product
    async function updateProduct(id) {
      const name = document.getElementById(`name-${id}`).value.trim();
      const price = parseFloat(document.getElementById(`price-${id}`).value);
      const category = document.getElementById(`category-${id}`).value || null;
      const imageUrl = document.getElementById(`imageUrl-${id}`).value.trim() || null;

      if (!name || !price) {
        showToast('Name and price are required', true);
        return;
      }

      try {
        const response = await fetch(`${SUPABASE_URL}/rest/v1/products?id=eq.${id}`, {
          method: 'PATCH',
          headers: {
            'apikey': SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
            'Content-Type': 'application/json',
            'Prefer': 'return=minimal'
          },
          body: JSON.stringify({ name, price, category, image_url: imageUrl })
        });

        if (response.ok) {
          showToast('‚úÖ Product updated successfully');
          loadProducts();
        } else {
          showToast('Failed to update product', true);
        }
      } catch (error) {
        console.error('Error updating product:', error);
        showToast('Failed to update product', true);
      }
    }

    // Delete product
    async function deleteProduct(id) {
      if (!confirm('‚ö†Ô∏è Delete this product? This action cannot be undone.')) return;

      try {
        const response = await fetch(`${SUPABASE_URL}/rest/v1/products?id=eq.${id}`, {
          method: 'DELETE',
          headers: {
            'apikey': SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
          }
        });

        if (response.ok) {
          showToast('‚úÖ Product deleted successfully');
          loadProducts();
        } else {
          showToast('Failed to delete product', true);
        }
      } catch (error) {
        console.error('Error deleting product:', error);
        showToast('Failed to delete product', true);
      }
    }

    // Helper function to escape HTML
    function escapeHtml(text) {
      const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
      };
      return String(text || '').replace(/[&<>"']/g, m => map[m]);
    }

    // Load products on page load
    loadProducts();
  </script>
</body>
</html>